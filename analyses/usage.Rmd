---
title: "How do students use the system?"
author: "Maarten van der Velde"
output: 
  html_notebook: 
    smart: false
    toc: TRUE
    toc_float:
      collapsed: false
---


# Load required packages
```{r}
library(dplyr)
library(lubridate)
library(tidyr)
library(ggplot2)

theme_set(theme_classic())
```


# Load data
```{r}
load("../data/cogpsych_data_anon.Rdata")
```



# Add time columns

```{r}
d <- data %>%
  mutate(start_time = as.POSIXct(presentationStartTime / 1000, origin = "1970-01-01", tz = "Europe/Amsterdam"),
         month = as.factor(month(start_time)),
         week = as.factor(week(start_time)),
         doy = as_date(start_time),
         weekday = factor(weekdays(start_time), levels = c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday")),
         hour = hour(floor_date(start_time, "hour")))
```


# Plot usage by date

The course started on 12 September, but the first RL chapters were only made available on 12 October, so use that as the starting point.
```{r}
start_date <- as_date("2017-09-12")
rl_available_date <- as_date("2017-10-12")
exam_date <- as_date("2017-11-01")
resit_date <- as_date("2017-12-07")

usage_by_doy <- d %>%
  group_by(doy) %>%
  tally() %>%
  ungroup() %>%
  complete(doy = seq.Date(rl_available_date, resit_date, by="day"), fill = list(n = 0)) %>%
  mutate(day_of_course = (doy - start_date))

# Absolute date
ggplot(usage_by_doy, aes(x = doy, y = n / 1000)) +
  geom_line() +
  scale_x_date(date_breaks = "1 month", date_labels = "%b %Y") +
  labs(x = "Date", y = "Number of trials (x 1000)") +
  geom_vline(xintercept = c(rl_available_date, exam_date, resit_date), lty = "dotted") +
  annotate("label", x = c(rl_available_date, exam_date, resit_date), y = 50, label = c("Start", "Exam", "Resit"))


# Day of course
ggplot(usage_by_doy, aes(x = day_of_course , y = n / 1000)) +
  geom_line() +
  scale_x_continuous() +
  labs(x = "Day of course", y = "Number of trials (x 1000)") +
  geom_vline(xintercept = c(rl_available_date - start_date, exam_date - start_date, resit_date - start_date), lty = "dotted") +
  annotate("label", x = c(rl_available_date - start_date, exam_date - start_date, resit_date - start_date), y = 50, label = c("Start", "Exam", "Resit"))

```



# Plot usage by hour of day

## Across days

The plot below shows the usage by hour averaged over the entire span of the course (a trial counts towards the hour in which it started, so a 14:59 trial counts as a 14:00 trial).
```{r}
usage_by_hour <- d %>%
  group_by(hour) %>%
  tally() %>%
  ungroup()

ggplot(usage_by_hour, aes(x = hour, y = n / 1000)) +
  geom_point() +
  geom_line() +
  scale_x_continuous(breaks = seq(0,23, by = 2)) +
  labs(x = "Hour of the day", y = "Number of trials (x 1000)", title = "Study frequency")

```

## Split by day

Since there are only 20 days between first availability of RL and the exam, we can plot usage for all days separately.
```{r}
usage_by_hour_of_doy <- d %>%
  filter(doy >= rl_available_date, doy <= exam_date) %>%
  group_by(doy, hour) %>%
  tally() %>%
  ungroup() %>%
  mutate(days_until_exam = exam_date - doy)

ggplot(usage_by_hour_of_doy, aes(x = hour, y = days_until_exam)) +
  geom_tile(aes(fill = n)) +
  coord_equal() +
  scale_fill_distiller(palette = "YlOrRd", direction = 1) +
  scale_x_continuous(breaks = seq(0,23, by = 2)) +
  scale_y_reverse() +
  labs(x = "Hour of the day", y = "Days until exam", title = "Study frequency") +
  guides(fill = guide_colourbar("Number of trials"))

```


## Split by weekday


The plot below shows the absolute number of study trials per hour of the day, summed over the entire duration of the course.
This plot shows which moments during the week are the most popular for studying (but it does not show variance between weeks).
The leadup to the exam is also clearly visible (Tuesday and Wednesday until 9am).
```{r}
usage_by_hour_of_day <- d %>%
  group_by(weekday, hour) %>%
  tally() %>%
  group_by(weekday) %>%
  mutate(freq = n/sum(n)) %>%
  ungroup() %>%
  mutate(weekday = factor(weekday, levels = rev(levels(weekday))))

ggplot(usage_by_hour_of_day, aes(x = hour, y = weekday)) +
  geom_tile(aes(fill = n)) +
  coord_equal() +
  scale_fill_distiller(palette = "YlOrRd", direction = 1) +
  scale_x_continuous(breaks = c(0:23)) +
  labs(x = "Hour of the day", y = "Day of the week", title = "Study frequency") +
  guides(fill = guide_colourbar("Number of trials"))

```



In the plot below, frequency is normalised within days (so that the sum of all hours in a day equals 1).
This lets us see how learning is distributed within a day, but does not allow direct comparison between days (points with the same colour do not necessarily have the same absolute study frequency, only the same relative frequency within their respective days).


```{r}
ggplot(usage_by_hour_of_day, aes(x = hour, y = weekday)) +
  geom_tile(aes(fill = freq)) +
  coord_equal() +
  scale_fill_distiller(palette = "YlOrRd", direction = 1) +
  scale_x_continuous(breaks = c(0:23)) +
  labs(x = "Hour of the day", y = "Day of the week", title = "Study frequency") +
  guides(fill = FALSE)
```


# Usage by learner

## Number of sessions

```{r}
session_count <- data %>%
  group_by(User) %>%
  summarise(sessions = length(unique(session)))

ggplot(session_count, aes(x = sessions)) +
  geom_histogram(binwidth = 10, colour = "black", fill = NA) +
  labs(x = "Number of sessions", title = "Number of sessions per user")
```

## Number of trials

```{r}
trial_count <- data %>%
  group_by(User) %>%
  summarise(trials = n())

ggplot(trial_count, aes(x = trials)) +
  geom_histogram(binwidth = 1000, colour = "black", fill = NA) +
  labs(x = "Number of trials", title = "Number of trials per user")
```


# Session length

## Number of trials

The histogram below shows that there is a narrow peak close to zero (users who start a session and immediately stop) and a wider peak to its right.
```{r}
session_length <- data %>% 
  group_by(User, session) %>%
  summarise(duration = (max(presentationStartTime) - min(presentationStartTime)) / (60 * 1000),
            trials = n())

ggplot(session_length, aes(x = trials)) +
  geom_histogram(binwidth = 5, colour = "black", fill = NA) +
  labs(x = "Session length (trials)")
```

## Duration

Users can specify beforehand how long their session should be.
Some session durations stand out in the histogram, in particular 8 minutes (the default duration) and 5 minutes, but there are also distinct peaks at multiples of 8 (16, 24, 32, 40) and multiples of 10 (10, 20, 30).
This regularity suggests that users have a tendency to finish a session once they have started.
```{r}
ggplot(session_length, aes(x = duration)) +
  geom_histogram(binwidth = 1, colour = "black", fill = NA) +
  labs(x = "Session duration (minutes)")

```



